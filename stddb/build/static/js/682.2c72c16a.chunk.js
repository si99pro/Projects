"use strict";(self.webpackChunkmemories=self.webpackChunkmemories||[]).push([[682],{1682:(e,i,t)=>{t.r(i),t.d(i,{default:()=>V});var s=t(5043),n=t(9900),r=t(3182),l=t(791),o=t(5472),a=t(3969),c=t(172),d=t(5895),u=t(298),m=t(6803),h=t(4343),g=t(3699),f=t(3089),v=t(6592),x=t(9067),b=t(4938),A=t(7471),p=t(2947),y=t(2097),j=t(916),k=t(9992),w=t(579);const C=(0,k.A)((0,w.jsx)("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send");var P=t(9073);const S=[{value:"general",label:"General"},{value:"academic",label:"Academic"},{value:"discussion",label:"Discussion"},{value:"important",label:"Important"},{value:"event",label:"Event"},{value:"other",label:"Other"}],I=/^https?:\/\/[^\s/$.?#].[^\s]*$/i,$="users";const N=function(){var e,i;const{user:t,isAdmin:n,userProfile:k,authLoading:N}=(0,r.As)(),T=null===k||void 0===k||null===(e=k.basicInfo)||void 0===e?void 0:e.batch,W=null===k||void 0===k||null===(i=k.basicInfo)||void 0===i?void 0:i.studentId,[F,M]=(0,s.useState)({title:"",message:"",link:"",audience:"private",category:"general"}),[E,q]=(0,s.useState)({}),[B,D]=(0,s.useState)(!1),[L,R]=(0,s.useState)({error:null,success:null}),[U,G]=(0,s.useState)(!1),O=(0,s.useCallback)(((e,i)=>{let t;switch(e){case"title":i.trim()||(t="Title is required.");break;case"message":i.trim()||(t="Message is required.");break;case"link":i.trim()&&!I.test(i.trim())&&(t="Must be a valid URL (e.g., https://example.com)")}return t}),[]),z=(0,s.useCallback)((()=>{const e={};let i=!0;const t=F,s=["title","message","link","category","audience"];for(const n of s){const s=t[n],r=O(n,s);r&&(e[n]=r,i=!1)}return"private"===t.audience&&(N?(e.audience="Verifying admin permissions...",i=!1):n?T||(e.audience="Private option disabled: Your batch info is missing in your profile.",i=!1):(e.audience="Private option disabled: Admin role required.",i=!1)),q(e),i}),[F,O,n,T,N]),V=(0,s.useCallback)((e=>{const{name:i,value:t}=e.target;M((e=>({...e,[i]:t}))),E[i]&&q((e=>({...e,[i]:void 0}))),"audience"===i&&E.audience&&q((e=>({...e,audience:void 0}))),R({error:null,success:null})}),[E]),Y=(0,s.useCallback)((e=>{const{name:i,value:t}=e.target,s=O(i,t);q((e=>({...e,[i]:s})))}),[O]),H=(0,s.useCallback)(((e,i)=>{"clickaway"!==i&&G(!1)}),[]),J=N||!n||n&&!T,Z=N||n?N||!n||T?"":"Your batch info is missing in profile.":"Admin role required to send private messages.";let _="";return E.audience?_=E.audience:"private"===F.audience&&J?_=Z:"private"!==F.audience||J?"everyone"===F.audience&&(_="Will be sent publicly to all users."):_=`Will be sent privately to batch ${T}.`,(0,w.jsxs)(a.A,{component:"form",onSubmit:async e=>{var i;if(e.preventDefault(),R({error:null,success:null}),!z())return void console.log("Form validation failed",E);D(!0);const t=l.j.currentUser;if(!t)return R({error:"Authentication error. Please log in again.",success:null}),void D(!1);const s="private"===F.audience?T:null,n=(null===k||void 0===k||null===(i=k.basicInfo)||void 0===i?void 0:i.fullName)||t.displayName||"Admin",r="private"===F.audience?"private":"public";let a=null;try{const e={title:F.title.trim(),message:F.message.trim(),category:F.category,audienceType:r,..."private"===r&&s&&{audienceTarget:s},senderName:n,senderStudentId:W||null,timestamp:(0,o.O5)(),...F.link.trim()&&{link:F.link.trim()}};console.log("Constructed notification data:",e),a=await(0,o.gS)((0,o.rJ)(l.db,"notifications"),e);const i=a.id;console.log("Main (audit) notification document created with ID:",i),console.log(`Distributing notification ${i} to users...`),await(async(e,i,t,s)=>{const n={read:!1,createdAt:(0,o.O5)(),readTimestamp:null,reacted:null,commented:!1,shared:!1},r=[],a=(0,o.rJ)(l.db,$);try{if("public"===t)console.log("Fetching all users for PUBLIC audience distribution..."),(await(0,o.GG)(a)).forEach((e=>r.push(e.id))),console.log(`Found ${r.length} users for public notification distribution.`);else{if("private"!==t||!s)return void console.log("No specific audience matched for distribution.");{console.log(`Fetching users for PRIVATE batch '${s}' distribution...`);const e=(0,o.P)(a,(0,o._M)("basicInfo.batch","==",s));(await(0,o.GG)(e)).forEach((e=>r.push(e.id))),console.log(`Found ${r.length} users in batch ${s}.`)}}if(0===r.length)return void console.log("No users found for the specified audience.");const c=(0,o.wP)(l.db);r.forEach((t=>{const s=(0,o.H9)(l.db,$,t,"notifications",e),r={...i,...n};c.set(s,r)})),await c.commit(),console.log(`Successfully distributed notification ${e} to ${r.length} users.`)}catch(c){throw console.error(`Error distributing notification ${e} to users:`,c),new Error(`Failed to distribute notification to users. ${c.message}`)}})(i,e,r,"private"===r?s:null),M({title:"",message:"",link:"",audience:"private",category:"general"}),q({}),R({error:null,success:"Notification sent successfully!"}),G(!0)}catch(c){console.error("Error during notification submission:",c),a&&c.message.includes("Failed to distribute")?R({error:`Notification created (ID: ${a.id}) but failed to distribute. ${c.message}`,success:null}):R(a?{error:`An unexpected error occurred: ${c.message}`,success:null}:{error:`Failed to create the notification document. ${c.message}`,success:null})}finally{D(!1)}},noValidate:!0,sx:{mt:1,maxWidth:700,mx:"auto"},children:[N&&(0,w.jsxs)(a.A,{sx:{display:"flex",justifyContent:"center",my:5},children:[(0,w.jsx)(c.A,{}),(0,w.jsx)(d.A,{sx:{ml:2},children:"Verifying permissions..."})]}),!N&&(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(d.A,{variant:"h6",gutterBottom:!0,sx:{mb:3},children:"Send New Notification"}),(0,w.jsxs)(u.A,{spacing:3,children:[L.error&&(0,w.jsx)(m.A,{severity:"error",onClose:()=>R((e=>({...e,error:null}))),children:L.error}),(0,w.jsx)(h.A,{required:!0,fullWidth:!0,id:"title",name:"title",label:"Notification Title",value:F.title,onChange:V,onBlur:Y,error:!!E.title,helperText:E.title||" ",disabled:B,autoFocus:!0}),(0,w.jsx)(h.A,{required:!0,fullWidth:!0,id:"message",name:"message",label:"Notification Message",multiline:!0,rows:4,value:F.message,onChange:V,onBlur:Y,error:!!E.message,helperText:E.message||" ",disabled:B}),(0,w.jsx)(h.A,{fullWidth:!0,id:"link",name:"link",label:"Optional Link (URL)",placeholder:"https://example.com",value:F.link,onChange:V,onBlur:Y,error:!!E.link,helperText:E.link||" ",disabled:B,InputProps:{startAdornment:(0,w.jsx)(g.A,{position:"start",children:(0,w.jsx)(P.A,{color:"action"})})}}),(0,w.jsxs)(f.A,{container:!0,spacing:2,alignItems:"flex-start",children:[(0,w.jsx)(f.A,{item:!0,xs:12,sm:6,children:(0,w.jsxs)(v.A,{fullWidth:!0,required:!0,error:!!E.category,disabled:B,children:[(0,w.jsx)(x.A,{id:"category-select-label",children:"Category"}),(0,w.jsx)(b.A,{labelId:"category-select-label",id:"category-select",name:"category",value:F.category,label:"Category",onChange:V,children:S.map((e=>(0,w.jsx)(A.A,{value:e.value,children:e.label},e.value)))}),(0,w.jsx)(p.A,{children:" "})]})}),(0,w.jsx)(f.A,{item:!0,xs:12,sm:6,children:(0,w.jsxs)(v.A,{fullWidth:!0,required:!0,error:!!E.audience,disabled:B,children:[(0,w.jsx)(x.A,{id:"audience-select-label",children:"Audience"}),(0,w.jsxs)(b.A,{labelId:"audience-select-label",id:"audience-select",name:"audience",value:F.audience,label:"Audience",onChange:V,children:[(0,w.jsx)(A.A,{value:"private",disabled:J,children:"Private (Your Batch)"},"private"),(0,w.jsx)(A.A,{value:"everyone",children:"Public (Everyone)"},"everyone")]}),(0,w.jsx)(p.A,{children:_||" "})]})})]}),(0,w.jsx)(a.A,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:(0,w.jsx)(y.A,{type:"submit",variant:"contained",disabled:B,startIcon:B?(0,w.jsx)(c.A,{size:20,color:"inherit"}):(0,w.jsx)(C,{}),sx:{minWidth:150},children:B?"Sending...":"Send Notification"})})]})]}),(0,w.jsx)(j.A,{open:U,autoHideDuration:5e3,onClose:H,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:L.success?(0,w.jsx)(m.A,{onClose:H,severity:"success",variant:"filled",sx:{width:"100%"},children:L.success}):void 0})]})};var T=t(9806),W=t(4799),F=t(4527),M=t(8387),E=t(1807),q=t(8128),B=t(1612),D=t(8301),L=t(9857),R=t(6061);function U(e){return(0,R.Ay)("MuiAlertTitle",e)}(0,L.A)("MuiAlertTitle",["root"]);const G=(0,q.Ay)(d.A,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(e,i)=>i.root})((0,B.A)((e=>{let{theme:i}=e;return{fontWeight:i.typography.fontWeightMedium,marginTop:-2}}))),O=s.forwardRef((function(e,i){const t=(0,D.b)({props:e,name:"MuiAlertTitle"}),{className:s,...n}=t,r=t,l=(e=>{const{classes:i}=e;return(0,E.A)({root:["root"]},U,i)})(r);return(0,w.jsx)(G,{gutterBottom:!0,component:"div",ownerState:r,ref:i,className:(0,M.A)(l.root,s),...n})}));var z=t(903);const V=function(){const{user:e,roles:i,authLoading:t}=(0,r.As)(),l=(0,n.Zp)(),[o,u]=(0,s.useState)(!0),[h,g]=(0,s.useState)(!1);return(0,s.useEffect)((()=>{if(!t&&!e)return console.log("Admin Page: No user found, navigating to login."),void l("/login");if(!t&&e)if(console.log("Admin Page: User found, checking roles:",i),void 0===i&&t)console.log("Admin Page: Auth/Roles still loading..."),u(!0);else{const e=Array.isArray(i)&&i.includes("admin");console.log("Admin Page: Has admin role?",e),g(e),u(!1)}else u(!0)}),[e,i,t,l]),t||o?(0,w.jsxs)(T.A,{maxWidth:"sm",sx:{mt:4,textAlign:"center"},children:[(0,w.jsx)(c.A,{}),(0,w.jsx)(d.A,{sx:{mt:2},children:"Loading Admin Panel..."})]}):(0,w.jsx)(T.A,{maxWidth:"md",sx:{mt:4,mb:4},children:(0,w.jsxs)(W.A,{elevation:3,sx:{p:{xs:2,md:4}},children:[(0,w.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",mb:2},children:[(0,w.jsx)(z.A,{color:"primary",sx:{mr:1.5,fontSize:"2rem"}}),(0,w.jsx)(d.A,{variant:"h4",component:"h1",gutterBottom:!0,sx:{mb:0},children:"Admin Panel"})]}),(0,w.jsx)(F.A,{sx:{mb:3}}),h?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(d.A,{variant:"subtitle1",color:"text.secondary",sx:{mb:3},children:"Use the form below to send notifications to users. Select the target audience and category appropriately."}),(0,w.jsx)(N,{})]}):(0,w.jsxs)(m.A,{severity:"error",children:[(0,w.jsx)(O,{children:"Access Denied"}),"You do not have permission to view this page. Please ensure you are logged in with an administrator account."]})]})})}}}]);
//# sourceMappingURL=682.2c72c16a.chunk.js.map